services:
  api:
    image: intelloop/atlas-cmms-backend
    depends_on:
      - minio
    environment:
      DB_URL: 10.0.1.1:5432/atlas_cmms
      DB_USER: ${POSTGRES_USER}
      DB_PWD: ${POSTGRES_PWD}

      PUBLIC_API_URL: ${PUBLIC_API_URL}
      PUBLIC_FRONT_URL: ${PUBLIC_FRONT_URL}
      PUBLIC_MINIO_ENDPOINT: ${PUBLIC_MINIO_ENDPOINT}
      KEYGEN_PRODUCT_TOKEN: ${KEYGEN_PRODUCT_TOKEN:-disabled}

      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}

      MINIO_ENDPOINT: http://minio:9000
      MINIO_BUCKET: atlas-bucket
      MINIO_ACCESS_KEY: ${MINIO_USER}
      MINIO_SECRET_KEY: ${MINIO_PASSWORD}
      STORAGE_TYPE: ${STORAGE_TYPE:-minio}

      SERVER_FORWARD_HEADERS_STRATEGY: native
      SERVER_USE_FORWARD_HEADERS: "true"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.atlas-api.rule=Host(`api.innmaintenance.com`)"
      - "traefik.http.routers.atlas-api.entrypoints=http"
      - "traefik.http.services.atlas-api.loadbalancer.server.port=8080"
    networks:
      - coolify

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    depends_on:
      - api
    environment:
      API_URL: ${PUBLIC_API_URL}
      PUBLIC_API_URL: ${PUBLIC_API_URL}
      NODE_ENV: production

      LOGO_PATHS: ${LOGO_PATHS:-}
      CUSTOM_COLORS: ${CUSTOM_COLORS:-}
      BRAND_CONFIG: ${BRAND_CONFIG:-}
      OAUTH2_PROVIDER: disabled
      GOOGLE_TRACKING_ID: disabled
      GOOGLE_KEY: disabled
      MUI_X_LICENSE: disabled
      CLOUD_VERSION: "false"
      ENABLE_SSO: "false"
      INVITATION_VIA_EMAIL: "false"
      DEMO_LINK: disabled
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.atlas-frontend.rule=Host(`app.innmaintenance.com`)"
      - "traefik.http.routers.atlas-frontend.entrypoints=http"
      - "traefik.http.services.atlas-frontend.loadbalancer.server.port=3000"
    networks:
      - coolify

  minio:
    image: minio/minio:RELEASE.2025-04-22T22-12-26Z
    environment:
      MINIO_ROOT_USER: ${MINIO_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD}
    volumes:
      - minio_data:/data
    command: server --address ":9000" --console-address ":9001" /data
    labels:
      - "traefik.enable=true"

      # MinIO S3 API (Å¡to Atlas koristi)
      - "traefik.http.routers.atlas-minio.rule=Host(`minio.innmaintenance.com`)"
      - "traefik.http.routers.atlas-minio.entrypoints=http"
      - "traefik.http.services.atlas-minio.loadbalancer.server.port=9000"

      # MinIO Console (admin UI)
      - "traefik.http.routers.atlas-minio-console.rule=Host(`minio-console.innmaintenance.com`)"
      - "traefik.http.routers.atlas-minio-console.entrypoints=http"
      - "traefik.http.services.atlas-minio-console.loadbalancer.server.port=9001"
    networks:
      - coolify

volumes:
  minio_data:

networks:
  coolify:
    external: true
